// Content script para automatizar juicios - Solo AFIP SIRAEF
(function() {
    'use strict';
    
    // Verificar que estamos en la URL correcta
    if (!window.location.href.includes('juridicosint.afip.gob.ar/atenea/siraef/consultas/Principal.asp')) {
        return; // No ejecutar si no estamos en la p√°gina correcta
    }
    
    console.log('Extensi√≥n cargada en AFIP SIRAEF');
    
    // Funci√≥n para crear el bot√≥n de automatizaci√≥n
    function createAutomationButton() {
        const button = document.createElement('button');
        button.id = 'automation-button';
        button.innerText = 'Automatizar Juicio 556402/2025 - AFIP';
        button.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            padding: 15px 25px;
            background: linear-gradient(45deg, #0066cc, #004499);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,102,204,0.3);
            transition: all 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        `;
        
        // Efectos hover espec√≠ficos para AFIP
        button.addEventListener('mouseenter', function() {
            this.style.background = 'linear-gradient(45deg, #004499, #002266)';
            this.style.transform = 'translateY(-3px) scale(1.02)';
            this.style.boxShadow = '0 6px 20px rgba(0,102,204,0.4)';
        });
        
        button.addEventListener('mouseleave', function() {
            this.style.background = 'linear-gradient(45deg, #0066cc, #004499)';
            this.style.transform = 'translateY(0) scale(1)';
            this.style.boxShadow = '0 4px 15px rgba(0,102,204,0.3)';
        });
        
        button.addEventListener('click', executeAutomation);
        
        document.body.appendChild(button);
    }
    
    // Funci√≥n principal de automatizaci√≥n
    function executeAutomation() {
        console.log('Iniciando automatizaci√≥n...');
        
        // Buscar campos espec√≠ficos por los nombres exactos de AFIP
        const numeroJuicioField = document.querySelector("body > form > table > tbody > tr:nth-child(1) > td:nth-child(2) > input");
        const a√±oField = document.querySelector("body > form > table > tbody > tr:nth-child(1) > td:nth-child(3) > input");
        const buscarButton = document.querySelector("body > form > table > tbody > tr:nth-child(2) > td > input"); 

/*         const numeroJuicioField = document.querySelector('input[name="juicio"]');
        const a√±oField = document.querySelector('input[name="anio"]');
        const buscarButton = document.querySelector('input[name="buscar"]') || 
                            document.querySelector('button[name="buscar"]') ||
                            document.querySelector('[name="buscar"]');
 */        
        console.log('Campos encontrados:', {
            numeroJuicioField: numeroJuicioField ? `INPUT[name="${numeroJuicioField.name}"]` : 'NO ENCONTRADO',
            a√±oField: a√±oField ? `INPUT[name="${a√±oField.name}"]` : 'NO ENCONTRADO',
            buscarButton: buscarButton ? `${buscarButton.tagName}[name="${buscarButton.name}"]` : 'NO ENCONTRADO'
        });
        
        if (numeroJuicioField && a√±oField && buscarButton) {
            console.log('‚úÖ Todos los campos encontrados, completando formulario...');
            
            // Limpiar campos primero
            numeroJuicioField.value = '';
            a√±oField.value = '';
            
            // Completar campos con los valores espec√≠ficos
            numeroJuicioField.value = '556402';
            numeroJuicioField.dispatchEvent(new Event('input', { bubbles: true }));
            numeroJuicioField.dispatchEvent(new Event('change', { bubbles: true }));
            numeroJuicioField.dispatchEvent(new Event('keyup', { bubbles: true }));
            
            a√±oField.value = '2025';
            a√±oField.dispatchEvent(new Event('input', { bubbles: true }));
            a√±oField.dispatchEvent(new Event('change', { bubbles: true }));
            a√±oField.dispatchEvent(new Event('keyup', { bubbles: true }));
            
            console.log('‚úÖ Campos completados:', {
                juicio: numeroJuicioField.value,
                anio: a√±oField.value
            });
            
            // Hacer click en buscar despu√©s de un peque√±o delay
            setTimeout(() => {
                console.log('üîç Ejecutando b√∫squeda...');
                buscarButton.click();
                
                // Esperar a que cargue el juicio y expandir tablas
                setTimeout(() => {
                    console.log('üìã Expandiendo tablas...');
                    expandAllTables();
                }, 3000); // Mayor tiempo de espera para AFIP
            }, 800);
            
        } else {
            console.log('‚ùå No se encontraron todos los campos necesarios');
            
            // Informaci√≥n de depuraci√≥n espec√≠fica
            const debugInfo = `
‚ùå CAMPOS NO ENCONTRADOS:

Buscando espec√≠ficamente:
‚Ä¢ input[name="juicio"] ‚Üí ${numeroJuicioField ? '‚úÖ ENCONTRADO' : '‚ùå NO ENCONTRADO'}
‚Ä¢ input[name="anio"] ‚Üí ${a√±oField ? '‚úÖ ENCONTRADO' : '‚ùå NO ENCONTRADO'}  
‚Ä¢ [name="buscar"] ‚Üí ${buscarButton ? '‚úÖ ENCONTRADO' : '‚ùå NO ENCONTRADO'}

Todos los campos INPUT en la p√°gina:
${getAllInputs().map(input => `‚Ä¢ ${input.tagName}[name="${input.name}"][id="${input.id}"] type="${input.type}"`).join('\n')}

Todos los botones en la p√°gina:
${getAllButtons().map(btn => `‚Ä¢ ${btn.tagName}[name="${btn.name}"][id="${btn.id}"] value="${btn.value || btn.innerText}"`).join('\n')}
            `;
            
            alert('No se pudieron encontrar todos los campos necesarios.\n\nRevisa la consola (F12) para m√°s informaci√≥n.');
            console.log(debugInfo);
        }
    }
    
    // Funci√≥n de depuraci√≥n para analizar la p√°gina
    function debugPageFields() {
        console.log('=== AN√ÅLISIS DE CAMPOS DE LA P√ÅGINA ===');
        
        const allInputs = getAllInputs();
        console.log('Campos de entrada encontrados:', allInputs.length);
        allInputs.forEach((input, index) => {
            console.log(`${index + 1}. ${input.tagName}`, {
                name: input.name,
                id: input.id,
                type: input.type,
                placeholder: input.placeholder,
                value: input.value,
                className: input.className
            });
        });
        
        const allButtons = getAllButtons();
        console.log('Botones encontrados:', allButtons.length);
        allButtons.forEach((btn, index) => {
            console.log(`${index + 1}. ${btn.tagName}`, {
                name: btn.name,
                id: btn.id,
                type: btn.type,
                innerText: btn.innerText,
                value: btn.value,
                className: btn.className
            });
        });
        
        console.log('=== FIN AN√ÅLISIS ===');
    }
    
    // Funci√≥n auxiliar para obtener todos los inputs
    function getAllInputs() {
        return Array.from(document.querySelectorAll('input'));
    }
    
    // Funci√≥n auxiliar para obtener todos los botones
    function getAllButtons() {
        return Array.from(document.querySelectorAll('button, input[type="button"], input[type="submit"]'));
    }
    
    // Funci√≥n para buscar campos espec√≠ficos de AFIP (mejorada)
    function findField(keywords) {
        console.log(`Buscando campo para palabras clave: ${keywords.join(', ')}`);
        
        // Selectores espec√≠ficos m√°s amplios para AFIP
        const specificSelectors = [
            // Variaciones comunes de n√∫mero de expediente
            'input[name*="nroExpediente"]',
            'input[name*="numeroExpediente"]',
            'input[name*="nroJuicio"]',
            'input[name*="numeroJuicio"]',
            'input[name*="expediente"]',
            'input[name*="juicio"]',
            'input[name*="numero"]',
            'input[name*="nro"]',
            
            // Variaciones de a√±o
            'input[name*="anio"]',
            'input[name*="a√±o"]',
            'input[name*="anoExpediente"]',
            'input[name*="year"]',
            
            // Por ID
            'input[id*="expediente"]',
            'input[id*="juicio"]',
            'input[id*="numero"]',
            'input[id*="nro"]',
            'input[id*="anio"]',
            'input[id*="a√±o"]',
            
            // Por placeholder
            'input[placeholder*="expediente"]',
            'input[placeholder*="juicio"]',
            'input[placeholder*="n√∫mero"]',
            'input[placeholder*="numero"]',
            'input[placeholder*="a√±o"]',
            'input[placeholder*="anio"]'
        ];
        
        // Probar selectores espec√≠ficos
        for (let selector of specificSelectors) {
            const elements = document.querySelectorAll(selector);
            for (let element of elements) {
                const name = (element.name || '').toLowerCase();
                const id = (element.id || '').toLowerCase();
                const placeholder = (element.placeholder || '').toLowerCase();
                
                for (let keyword of keywords) {
                    if (name.includes(keyword) || id.includes(keyword) || placeholder.includes(keyword)) {
                        console.log(`Campo encontrado con selector espec√≠fico: ${selector}`, element);
                        return element;
                    }
                }
            }
        }
        
        // B√∫squeda general mejorada
        const inputs = document.querySelectorAll('input[type="text"], input[type="number"], input:not([type]), input[type=""]');
        
        for (let input of inputs) {
            const id = (input.id || '').toLowerCase();
            const name = (input.name || '').toLowerCase();
            const placeholder = (input.placeholder || '').toLowerCase();
            const label = getAssociatedLabel(input)?.toLowerCase() || '';
            
            // Logging detallado
            console.log(`Evaluando input:`, {
                element: input,
                name,
                id,
                placeholder,
                label,
                keywords
            });
            
            for (let keyword of keywords) {
                if (id.includes(keyword) || name.includes(keyword) || 
                    placeholder.includes(keyword) || label.includes(keyword)) {
                    console.log(`Campo encontrado por b√∫squeda general: keyword="${keyword}"`, input);
                    return input;
                }
            }
        }
        
        console.log(`No se encontr√≥ campo para palabras clave: ${keywords.join(', ')}`);
        return null;
    }
    
    // Funci√≥n para buscar botones espec√≠ficos de AFIP (mejorada)
    function findButton(keywords) {
        console.log(`Buscando bot√≥n para palabras clave: ${keywords.join(', ')}`);
        
        // Selectores espec√≠ficos ampliados para AFIP
        const specificSelectors = [
            'input[name*="btnBuscar"]',
            'input[name*="buscar"]',
            'input[value*="Buscar"]',
            'input[value*="BUSCAR"]',
            'input[value*="Consultar"]',
            'input[value*="CONSULTAR"]',
            'button[name*="buscar"]',
            'button[name*="consultar"]',
            'input[type="submit"]',
            'button[type="submit"]',
            'input[id*="buscar"]',
            'input[id*="consultar"]',
            'button[id*="buscar"]',
            'button[id*="consultar"]'
        ];
        
        // Probar selectores espec√≠ficos
        for (let selector of specificSelectors) {
            const elements = document.querySelectorAll(selector);
            for (let element of elements) {
                console.log(`Bot√≥n encontrado con selector espec√≠fico: ${selector}`, element);
                return element;
            }
        }
        
        // B√∫squeda general mejorada
        const buttons = document.querySelectorAll('button, input[type="button"], input[type="submit"], input[type="image"]');
        
        for (let button of buttons) {
            const text = (button.innerText || button.value || '').toLowerCase();
            const id = (button.id || '').toLowerCase();
            const name = (button.name || '').toLowerCase();
            const title = (button.title || '').toLowerCase();
            
            console.log(`Evaluando bot√≥n:`, {
                element: button,
                text,
                name,
                id,
                title,
                keywords
            });
            
            for (let keyword of keywords) {
                if (text.includes(keyword) || id.includes(keyword) || 
                    name.includes(keyword) || title.includes(keyword)) {
                    console.log(`Bot√≥n encontrado por b√∫squeda general: keyword="${keyword}"`, button);
                    return button;
                }
            }
        }
        
        console.log(`No se encontr√≥ bot√≥n para palabras clave: ${keywords.join(', ')}`);
        return null;
    }
    
    // Funci√≥n para obtener la etiqueta asociada a un input
    function getAssociatedLabel(input) {
        // Buscar label por 'for' attribute
        if (input.id) {
            const label = document.querySelector(`label[for="${input.id}"]`);
            if (label) return label.innerText;
        }
        
        // Buscar label padre
        const parentLabel = input.closest('label');
        if (parentLabel) return parentLabel.innerText;
        
        // Buscar texto cercano
        const parent = input.parentElement;
        if (parent) {
            const text = parent.innerText.replace(input.value || '', '').trim();
            return text;
        }
        
        return '';
    }
    
    // Funci√≥n para expandir todas las tablas/divs colapsables
    function expandAllTables() {
        console.log('Expandiendo todas las tablas...');
        
        // Buscar elementos colapsables comunes
        const expandableElements = [
            // Bootstrap collapse
            ...document.querySelectorAll('[data-toggle="collapse"]'),
            ...document.querySelectorAll('[data-bs-toggle="collapse"]'),
            
            // Elementos con clases comunes de expansi√≥n
            ...document.querySelectorAll('.collapse-toggle, .expand-toggle, .accordion-toggle'),
            
            // Botones que contengan texto de expandir
            ...document.querySelectorAll('button, a, div, span')
        ].filter(el => {
            const text = el.innerText?.toLowerCase() || '';
            const title = el.title?.toLowerCase() || '';
            return text.includes('expandir') || text.includes('mostrar') || 
                   text.includes('expand') || text.includes('show') ||
                   text.includes('+') || title.includes('expandir') ||
                   title.includes('mostrar');
        });
        
        // Expandir divs colapsados
        const collapsedDivs = document.querySelectorAll('div.collapse:not(.show)');
        collapsedDivs.forEach(div => {
            div.classList.add('show');
            div.style.display = 'block';
        });
        
        // Hacer click en elementos expandibles
        expandableElements.forEach((element, index) => {
            setTimeout(() => {
                try {
                    element.click();
                    console.log('Elemento expandido:', element);
                } catch (e) {
                    console.log('Error al expandir elemento:', e);
                }
            }, index * 200);
        });
        
        // Buscar y expandir acordeones
        const accordions = document.querySelectorAll('[id*="accordion"], [class*="accordion"]');
        accordions.forEach(accordion => {
            const headers = accordion.querySelectorAll('.accordion-header, .card-header, [data-toggle="collapse"]');
            headers.forEach((header, index) => {
                setTimeout(() => {
                    try {
                        header.click();
                    } catch (e) {
                        console.log('Error al expandir acorde√≥n:', e);
                    }
                }, index * 300);
            });
        });
        
        // Forzar visibilidad de elementos ocultos relacionados con tablas
        const hiddenTables = document.querySelectorAll('table[style*="display: none"], .table-hidden, .hidden-content');
        hiddenTables.forEach(table => {
            table.style.display = 'table';
            table.classList.remove('hidden', 'table-hidden');
        });
        
        console.log('Proceso de expansi√≥n completado');
    }
    
    // Crear el bot√≥n cuando la p√°gina est√© lista
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', createAutomationButton);
    } else {
        createAutomationButton();
    }
    
    // Observer para detectar cambios din√°micos en la p√°gina
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                // Si se detectan cambios significativos, verificar si necesitamos expandir nuevas tablas
                const hasNewTables = Array.from(mutation.addedNodes).some(node => 
                    node.nodeType === 1 && (
                        node.querySelector && (
                            node.querySelector('table') || 
                            node.querySelector('.collapse') ||
                            node.querySelector('[data-toggle="collapse"]')
                        )
                    )
                );
                
                if (hasNewTables) {
                    setTimeout(expandAllTables, 1000);
                }
            }
        });
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
    
})();